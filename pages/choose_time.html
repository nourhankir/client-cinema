<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Choose Showtime â€“ Smart Cinema</title>
  <link rel="stylesheet" href="../styles/choose_time.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
</head>
<body>
  <div class="movie-header" id="movieHeader">
    <img id="moviePoster" src="" alt="Poster" />
    <div>
      <h1 id="movieTitle">Loading...</h1>
    </div>
  </div>

  <h2>Select Date</h2>
  <div class="date-picker" id="datePicker"></div>

  <h2>Available Showtimes</h2>
  <div id="auditoriumsContainer" class="auditoriums-Container"></div>

  <button id="continueBtn" disabled>Continue</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const movieId = params.get("movie_id");
    const datePicker = document.getElementById('datePicker');
    const container = document.getElementById('auditoriumsContainer');
    const continueBtn = document.getElementById('continueBtn');
    const movieTitleEl = document.getElementById('movieTitle');
    const moviePosterEl = document.getElementById('moviePoster');
    let selectedData = null;

    fetch(`http://localhost/cinema-server/controllers/get_movie.php?id=${movieId}`)
      .then(res => res.json())
      .then(movie => {
        movieTitleEl.textContent = movie.title;
        moviePosterEl.src = movie.poster_url;
         // or any value you want
      });

    fetch(`http://localhost/cinema-server/controllers/showtimes_by_movie.php?movie_id=${movieId}`)
      .then(res => res.json())
      .then(data => {
        const grouped = {};
        data.forEach(s => {
          if (!grouped[s.show_date]) grouped[s.show_date] = [];
          grouped[s.show_date].push(s);
        });

        Object.keys(grouped).forEach((date, idx) => {
          const btn = document.createElement('button');
          btn.textContent = date;
          btn.className = 'date-btn' + (idx === 0 ? ' active' : '');
          btn.onclick = () => {
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderAuditoriums(grouped[date], date);
          };
          datePicker.appendChild(btn);
        });

        renderAuditoriums(grouped[Object.keys(grouped)[0]], Object.keys(grouped)[0]);
      });

    function renderAuditoriums(showtimes, selectedDate) {
      container.innerHTML = '';
      selectedData = null;
      continueBtn.disabled = true;
      continueBtn.classList.remove('enabled');

      const byAuditorium = {};
      showtimes.forEach(s => {
        if (!byAuditorium[s.auditorium_id]) {
          byAuditorium[s.auditorium_id] = {
            name: s.auditorium_name,
            price: s.price,
            times: []
          };
        }
        byAuditorium[s.auditorium_id].times.push({
          time: s.show_time,
          showtime_id: s.id
        });
      });

      Object.entries(byAuditorium).forEach(([id, a]) => {
        const div = document.createElement('div');
        div.className = 'auditorium-group';
        div.innerHTML = `
          <div class="auditorium-header">
            <span>${a.name}</span>
            <span>${a.price} $</span>
          </div>
          <div class="showtime-buttons">
            ${a.times.map(t => `
              <button 
                class="showtime-btn"
                data-time="${t.time}"
                data-date="${selectedDate}"
                data-auditorium="${a.name}"
                data-price="${a.price}"
                data-showtime-id="${t.showtime_id}">
                ${t.time.slice(0,5)}
              </button>
            `).join('')}
          </div>
        `;
        container.appendChild(div);

        div.querySelectorAll('.showtime-btn').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.showtime-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            selectedData = {
              movie_id: movieId,
              showtime_id: btn.dataset.showtimeId,
              show_time: btn.dataset.time,
              show_date: btn.dataset.date,
              auditorium: btn.dataset.auditorium,
              price: btn.dataset.price
            };

            continueBtn.disabled = false;
            continueBtn.classList.add('enabled');
          };
        });
      });
    }

    continueBtn.onclick = () => {
      if (selectedData) {
        localStorage.setItem('selected_showtime', JSON.stringify(selectedData));
        window.location.href = 'select_seats.html';
      }
    };
  </script>
</body>
</html>

